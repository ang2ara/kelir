Code from external sources, with possible minor modification.